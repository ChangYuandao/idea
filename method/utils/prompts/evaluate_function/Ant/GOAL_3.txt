import numpy as np

def trajectory_evaluate(trajectory_a, trajectory_b):
    """
    Both trajectory_a and trajectory_b are lists, each containing multiple states,
    and each state is represented as a dictionary.

    The label_list is a list of indices that corresponds to the states in the subtrajectory
    where A is definitively better or worse than B.

    The label indicates the quality of the sub-trajectory:
      - if A is better, the label is 1 ("Former")
      - if B is better, the label is -1 ("Latter")
      - if no valid sub-trajectory can be found between the two trajectories, label_list will be an empty list ([]).
    """
    traj_a_length = len(trajectory_a)
    traj_b_length = len(trajectory_b)
    assert traj_a_length == traj_b_length

    label_list = []

    for state_index in range(traj_a_length):
        state_a_info = trajectory_a[state_index]
        state_b_info = trajectory_b[state_index]

        # Extract root states for both trajectories
        root_states_a = state_a_info['root_states']  # [pos_x, pos_y, pos_z, quat_x, quat_y, quat_z, quat_w, vel_x, vel_y, vel_z, ang_vel_x, ang_vel_y, ang_vel_z]
        root_states_b = state_b_info['root_states']

        # Extract forward velocity (x-component of linear velocity)
        forward_vel_a = root_states_a[:, 7]  # x-velocity
        forward_vel_b = root_states_b[:, 7]  # x-velocity

        # Extract positions to calculate forward displacement
        pos_a = root_states_a[:, 0:3]  # [x, y, z]
        pos_b = root_states_b[:, 0:3]  # [x, y, z]

        # Calculate forward displacement (x-position)
        forward_disp_a = pos_a[:, 0]
        forward_disp_b = pos_b[:, 0]

        # Calculate forward speed (absolute value of forward velocity)
        forward_speed_a = np.abs(forward_vel_a)
        forward_speed_b = np.abs(forward_vel_b)

        # Calculate potential values (negative distance to target normalized by dt)
        potentials_a = state_a_info['potentials']
        potentials_b = state_b_info['potentials']

        # Compare metrics for forward movement
        # Higher forward velocity indicates faster forward movement
        # Higher forward displacement indicates more distance covered forward
        # Higher potential values indicate being closer to target (less negative)
        
        # Check if trajectory A is definitively better in all forward movement metrics
        if (forward_vel_a >= forward_vel_b).all() and (forward_disp_a >= forward_disp_b).all() and (forward_speed_a >= forward_speed_b).all() and (potentials_a >= potentials_b).all():
            label_list.append(1)
        # Check if trajectory B is definitively better in all forward movement metrics
        elif (forward_vel_a <= forward_vel_b).all() and (forward_disp_a <= forward_disp_b).all() and (forward_speed_a <= forward_speed_b).all() and (potentials_a <= potentials_b).all():
            label_list.append(-1)
        else:
            label_list.append(0)

    return label_list